<!DOCTYPE html>
<html lang="en">
<head>
<script>
(function() {
    'use strict';
    const SECRET_KEY = 'watermelontrinidad';
    const urlParams = new URLSearchParams(window.location.search);
    const providedKey = urlParams.get('key');
    
    if (providedKey !== SECRET_KEY) {
        window.location.replace('/');
        throw new Error('Access denied');
    }
    
    console.log('üîì Access granted to private dashboard');
    
    document.addEventListener('DOMContentLoaded', function() {
        const links = document.querySelectorAll('a[href*="private-dash"], a[href^="./"], a[href^="../"], a[href^="/private-dash"]');
        
        links.forEach(link => {
            const href = link.getAttribute('href');
            if (href.includes('http') \&\& !href.includes(window.location.hostname)) return;
            if (href.includes('key=')) return;
            
            const separator = href.includes('?') ? '&' : '?';
            link.href = href + separator + 'key=' + SECRET_KEY;
        });
        
        const relativeLinks = document.querySelectorAll('a[href$=".html"]:not([href*="http"])');
        relativeLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (!href.includes('key=')) {
                const separator = href.includes('?') ? '&' : '?';
                link.href = href + separator + 'key=' + SECRET_KEY;
            }
        });
    });
})();
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="callworks-favicon.svg">
  <title>CallWorks | Active Positions</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-hover: #1a1a2a;
      --border: #2a2a3a;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --text-muted: #555;
      --green: #00ff88;
      --green-dim: #00aa55;
      --amber: #ffaa00;
      --red: #ff4444;
      --blue: #4488ff;
    }
    
    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .logo { font-size: 1.5rem; font-weight: 700; color: var(--green); text-decoration: none; }
    .logo:hover { opacity: 0.8; }
    
    nav a { color: var(--text-secondary); text-decoration: none; margin-left: 24px; transition: color 0.2s; }
    nav a:hover { color: var(--green); }
    nav a.active { color: var(--green); }
    
    .summary-bar { display: flex; gap: 24px; margin-bottom: 30px; flex-wrap: wrap; }
    
    .summary-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 180px;
    }
    
    .summary-icon { font-size: 1.5rem; }
    .summary-text { display: flex; flex-direction: column; }
    .summary-label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; }
    .summary-value { font-size: 1.25rem; font-weight: 600; }
    .summary-value.positive { color: var(--green); }
    .summary-value.negative { color: var(--red); }
    .summary-value.warning { color: var(--amber); }
    
    .section-title {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin: 30px 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
    }
    .section-title:hover { color: var(--text-primary); }
    .section-title .toggle { margin-left: 8px; font-size: 0.8rem; }
    
    .positions-grid { display: grid; gap: 20px; }
    
    .position-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.2s;
    }
    .position-card:hover { border-color: var(--text-secondary); }
    .position-card.profitable { border-left: 4px solid var(--green); }
    .position-card.watch { border-left: 4px solid var(--amber); }
    .position-card.danger { border-left: 4px solid var(--red); }
    .position-card.expired { border-left: 4px solid var(--text-muted); opacity: 0.6; }
    
    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .position-symbol { display: flex; align-items: center; gap: 12px; }
    .symbol-name { font-size: 1.5rem; font-weight: 700; color: var(--amber); }
    
    .option-badge { padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .option-badge.call { background: rgba(0, 255, 136, 0.15); color: var(--green); }
    .option-badge.put { background: rgba(255, 68, 68, 0.15); color: var(--red); }
    
    .position-status { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    
    .status-badge { padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .status-badge.hold { background: rgba(0, 255, 136, 0.15); color: var(--green); }
    .status-badge.close { background: rgba(255, 170, 0, 0.15); color: var(--amber); }
    .status-badge.danger { background: rgba(255, 68, 68, 0.15); color: var(--red); }
    .status-badge.expired-badge { background: rgba(100, 100, 100, 0.15); color: var(--text-secondary); }
    
    .dte { font-size: 0.85rem; color: var(--text-secondary); }
    .dte.urgent { color: var(--red); font-weight: 600; }
    .dte.warning { color: var(--amber); }
    
    .position-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .detail-item { display: flex; flex-direction: column; gap: 4px; }
    .detail-label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; }
    .detail-value { font-size: 1rem; font-weight: 500; }
    .detail-value.positive { color: var(--green); }
    .detail-value.negative { color: var(--red); }
    .detail-value.warning { color: var(--amber); }
    
    .greeks-row {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .greek-item { display: flex; gap: 6px; font-size: 0.85rem; }
    .greek-label { color: var(--text-muted); }
    .greek-value { color: var(--blue); font-weight: 500; }
    
    .position-notes {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 12px;
    }
    .position-notes strong { color: var(--amber); }
    
    .action-recommendation {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 12px;
    }
    .action-recommendation.hold { background: rgba(0, 255, 136, 0.1); color: var(--green); }
    .action-recommendation.close { background: rgba(255, 170, 0, 0.1); color: var(--amber); }
    .action-recommendation.danger { background: rgba(255, 68, 68, 0.1); color: var(--red); }
    .action-recommendation.expiring { background: rgba(100, 100, 100, 0.1); color: var(--text-secondary); }
    
    .tagline { color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; }
    .update-time { color: var(--text-muted); font-size: 0.8rem; }
    
    footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      text-align: center;
    }
    footer p { color: var(--text-muted); font-size: 0.8rem; }
    
    .hidden { display: none; }
    
    @media (max-width: 768px) {
      .position-details { grid-template-columns: repeat(2, 1fr); }
      .summary-bar { gap: 12px; }
      .summary-item { min-width: 140px; padding: 12px 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="callworks.html" class="logo">üìû CallWorks</a>
        <div class="tagline">If You Ain't Theta Decaying, You Ain't Playing</div>
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span class="update-time" id="update-time"></span>
        <nav>
          <a href="callworks.html">Overview</a>
          <a href="callworks-active.html" class="active">Active</a>
          <a href="callworks-history.html">History</a>
        </nav>
      </div>
    </header>

    <div class="summary-bar" id="summary-bar"></div>

    <div id="active-section">
      <div class="positions-grid" id="active-positions"></div>
    </div>

    <div id="expiring-section" class="hidden">
      <div class="section-title" onclick="toggleSection('expiring-grid')">
        ‚è∞ Expiring Today / Expired <span class="toggle" id="expiring-grid-toggle">‚ñº</span>
      </div>
      <div class="positions-grid" id="expiring-grid"></div>
    </div>

    <div id="closed-section" class="hidden">
      <div class="section-title" onclick="toggleSection('closed-grid')">
        üìÅ Closed / Rolled Positions <span class="toggle" id="closed-grid-toggle">‚ñº</span>
      </div>
      <div class="positions-grid" id="closed-grid"></div>
    </div>

    <footer>
      <nav style="margin-bottom: 12px; font-size: 0.85rem;">
        <a href="index.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üè† Command Centre</a>
        <a href="operations.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üìä Operations</a>
        <a href="callworks.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üìû CallWorks</a>
        <a href="evolution.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üåÜ Jamestown</a>
        <a href="logbook.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üìú Logbook</a>
        <a href="vc-dashboard.html" style="color: var(--text-secondary); text-decoration: none; margin-right: 16px;">üíº VC Portfolio</a>
        <a href="api-dashboard.html" style="color: var(--text-secondary); text-decoration: none;">üìà API Costs</a>
      </nav>
      <p>CallWorks Active Positions ‚Ä¢ Data-driven ‚Ä¢ Updated during market hours</p>
    </footer>
  </div>

<script>
// ‚îÄ‚îÄ Black-Scholes Greeks ‚îÄ‚îÄ
function normalCDF(x) {
  const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x) / Math.sqrt(2);
  const t = 1.0 / (1.0 + p * x);
  const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
  return 0.5 * (1.0 + sign * y);
}

function normalPDF(x) {
  return Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
}

function calcGreeks(S, K, T, r, sigma, type) {
  // S=spot, K=strike, T=years to expiry, r=risk-free, sigma=IV, type=call/put
  if (T <= 0) return { delta: type === 'call' ? (S > K ? 1 : 0) : (S < K ? -1 : 0), theta: 0, gamma: 0 };
  const sqrtT = Math.sqrt(T);
  const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * sqrtT);
  const d2 = d1 - sigma * sqrtT;
  const Nd1 = normalCDF(d1);
  const Nd2 = normalCDF(d2);
  const nd1 = normalPDF(d1);
  
  let delta, theta;
  if (type === 'call') {
    delta = Nd1;
    theta = (-S * nd1 * sigma / (2 * sqrtT) - r * K * Math.exp(-r * T) * Nd2) / 365;
  } else {
    delta = Nd1 - 1;
    theta = (-S * nd1 * sigma / (2 * sqrtT) + r * K * Math.exp(-r * T) * normalCDF(-d2)) / 365;
  }
  const gamma = nd1 / (S * sigma * sqrtT);
  
  // For short positions, flip signs
  return { delta: -delta, theta: -theta, gamma };
}

function getDTE(expDate) {
  const now = new Date();
  const exp = new Date(expDate + 'T16:00:00');  // Market close ET
  const diff = exp - now;
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatMoney(val) {
  if (val === undefined || val === null) return '‚Äî';
  return '$' + Math.abs(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getCardClass(pos, dte, price) {
  if (['rolled', 'closed', 'expiring_worthless', 'expired'].includes(pos.status)) return 'expired';
  if (pos.status === 'consider_close' || (pos.profitPct && pos.profitPct > 75)) return 'watch';
  const isITM = pos.type === 'call' ? price >= pos.strike : price <= pos.strike;
  if (isITM) return 'danger';
  if (dte <= 3 && dte >= 0) return 'watch';
  return 'profitable';
}

function getStatusBadge(pos, dte, price) {
  if (pos.status === 'rolled') return { text: 'ROLLED', cls: 'expired-badge' };
  if (pos.status === 'closed') return { text: 'CLOSED', cls: 'expired-badge' };
  if (['expiring_worthless', 'expired'].includes(pos.status) || dte < 0) return { text: 'EXPIRED', cls: 'expired-badge' };
  
  const isITM = pos.type === 'call' ? price >= pos.strike : price <= pos.strike;
  if (isITM) return { text: '‚ö†Ô∏è ITM', cls: 'danger' };
  if (pos.profitPct && pos.profitPct > 75) return { text: 'TAKE PROFIT', cls: 'close' };
  if (dte <= 1) return { text: 'EXPIRING', cls: 'close' };
  if (dte <= 3) return { text: `${dte} DTE`, cls: 'close' };
  return { text: 'ACTIVE', cls: 'hold' };
}

function getActionRec(pos, dte, price) {
  if (['rolled', 'closed', 'expiring_worthless', 'expired'].includes(pos.status) || dte < 0) 
    return { text: '‚úì Position closed', cls: 'expiring' };
  
  const isITM = pos.type === 'call' ? price >= pos.strike : price <= pos.strike;
  if (isITM) return { text: '‚ö†Ô∏è ASSIGNMENT RISK ‚Äî Consider rolling or closing', cls: 'danger' };
  if (pos.profitPct && pos.profitPct > 75) return { text: 'üí∞ CONSIDER CLOSING ‚Äî ' + pos.profitPct.toFixed(0) + '% profit captured', cls: 'close' };
  if (dte <= 1) return { text: '‚è∞ EXPIRING ‚Äî Let expire or close', cls: 'expiring' };
  return { text: 'üîÑ HOLD ‚Äî Theta decaying', cls: 'hold' };
}

function renderCard(pos, prices, optionPrices) {
  const price = prices[pos.symbol] || 0;
  const dte = getDTE(pos.expiration);
  const cardClass = getCardClass(pos, dte, price);
  const badge = getStatusBadge(pos, dte, price);
  const action = getActionRec(pos, dte, price);
  
  const contracts = Math.abs(pos.contracts);
  const totalPremium = pos.premiumCollected || (pos.entryPrice * contracts * 100);
  
  // Option price lookup
  const optKey = `${pos.symbol}_${pos.strike}_${pos.expiration}_${pos.type}`;
  const optData = (optionPrices || {})[optKey];
  
  // Distance from strike
  let distPct = 0, distLabel = '';
  if (price > 0) {
    distPct = ((pos.strike - price) / price * 100);
    if (pos.type === 'call') {
      distLabel = distPct > 0 ? `${distPct.toFixed(1)}% OTM` : `${Math.abs(distPct).toFixed(1)}% ITM`;
    } else {
      distPct = ((price - pos.strike) / price * 100);
      distLabel = distPct > 0 ? `${Math.abs(((pos.strike - price) / price * 100)).toFixed(1)}% OTM` : `${Math.abs(distPct).toFixed(1)}% ITM`;
    }
  }
  
  // Current option price & P/L
  let currentPriceHTML = '';
  let plPerContractHTML = '';
  if (optData) {
    const mid = (optData.bid > 0 && optData.ask > 0) ? (optData.bid + optData.ask) / 2 : optData.last;
    const currentPrice = mid || optData.last || 0;
    const isProfit = currentPrice < pos.entryPrice;
    const priceColor = currentPrice < pos.entryPrice ? 'positive' : (currentPrice > pos.entryPrice ? 'negative' : '');
    currentPriceHTML = `<div class="detail-item"><span class="detail-label">Current Price</span><span class="detail-value ${priceColor}">$${currentPrice.toFixed(2)}</span></div>`;
    
    // P/L per contract for short positions (entry - current = profit)
    const plPerContract = (pos.entryPrice - currentPrice) * 100;
    const plTotal = plPerContract * contracts;
    const plClass = plPerContract >= 0 ? 'positive' : 'negative';
    plPerContractHTML = `<div class="detail-item"><span class="detail-label">P/L per Contract</span><span class="detail-value ${plClass}">${plPerContract >= 0 ? '+' : '-'}$${Math.abs(plPerContract).toFixed(2)}</span></div>`;
  }

  // Greeks ‚Äî use real Finnhub data if available, else Black-Scholes
  let greeksHTML = '';
  const isOpen = !['rolled', 'closed', 'expiring_worthless', 'expired'].includes(pos.status) && dte > 0;
  if (isOpen && price > 0) {
    let g;
    let greekSource = '';
    if (optData && (optData.delta !== 0 || optData.theta !== 0)) {
      // Real Greeks from Finnhub (negate for short positions)
      g = { delta: -(optData.delta || 0), theta: -(optData.theta || 0), gamma: optData.gamma || 0 };
      greekSource = ' ¬∑ üî¥ Live';
    } else {
      const T = Math.max(dte, 0.01) / 365;
      const iv = pos.iv || 0.35;
      g = calcGreeks(price, pos.strike, T, 0.05, iv, pos.type);
      greekSource = ' ¬∑ Est';
    }
    const ivDisplay = optData && optData.iv ? `<div class="greek-item"><span class="greek-label">IV</span> <span class="greek-value">${optData.iv.toFixed(1)}%</span></div>` : '';
    const volDisplay = optData && optData.volume ? `<div class="greek-item"><span class="greek-label">Vol</span> <span class="greek-value">${optData.volume.toLocaleString()}</span></div>` : '';
    greeksHTML = `
      <div class="greeks-row">
        <div class="greek-item"><span class="greek-label">Œî</span> <span class="greek-value">${g.delta.toFixed(3)}</span></div>
        <div class="greek-item"><span class="greek-label">Œò</span> <span class="greek-value">${g.theta > 0 ? '+' : ''}$${g.theta.toFixed(2)}/day</span></div>
        ${ivDisplay}
        ${volDisplay}
        <div class="greek-item"><span class="greek-label">DTE</span> <span class="greek-value">${dte}</span></div>
        <div class="greek-item"><span class="greek-label">Dist</span> <span class="greek-value ${distPct < 0 ? 'negative' : ''}">${distLabel}</span></div>
        <span style="color: var(--text-muted); font-size: 0.75rem;">${greekSource}</span>
      </div>`;
  }
  
  // DTE display
  let dteClass = '';
  let dteText = '';
  if (dte < 0) { dteText = 'Expired'; dteClass = ''; }
  else if (dte === 0) { dteText = 'Expires TODAY'; dteClass = 'urgent'; }
  else if (dte === 1) { dteText = '1 DTE'; dteClass = 'urgent'; }
  else if (dte <= 3) { dteText = `${dte} DTE`; dteClass = 'warning'; }
  else { dteText = `${dte} DTE`; }
  
  const notesHTML = pos.notes ? `<div class="position-notes">${pos.notes}</div>` : '';
  
  // P/L display
  let plHTML = '';
  if (pos.pnl !== undefined) {
    const plClass = pos.pnl >= 0 ? 'positive' : 'negative';
    plHTML = `<div class="detail-item"><span class="detail-label">P/L</span><span class="detail-value ${plClass}">${pos.pnl >= 0 ? '+' : '-'}${formatMoney(pos.pnl)}</span></div>`;
  } else if (pos.profitPct !== undefined) {
    plHTML = `<div class="detail-item"><span class="detail-label">Profit</span><span class="detail-value positive">+${pos.profitPct.toFixed(1)}%</span></div>`;
  }
  
  return `
    <div class="position-card ${cardClass}">
      <div class="position-header">
        <div class="position-symbol">
          <span class="symbol-name">${pos.symbol}</span>
          <span class="option-badge ${pos.type}">${pos.type.toUpperCase()}</span>
          <span style="color: var(--text-secondary); font-size: 0.9rem;">$${pos.strike} strike</span>
        </div>
        <div class="position-status">
          <span class="status-badge ${badge.cls}">${badge.text}</span>
          <span class="dte ${dteClass}">${formatDate(pos.expiration)} ¬∑ ${dteText}</span>
        </div>
      </div>
      <div class="position-details">
        <div class="detail-item"><span class="detail-label">Contracts</span><span class="detail-value">${contracts}</span></div>
        <div class="detail-item"><span class="detail-label">Entry Premium</span><span class="detail-value">$${pos.entryPrice.toFixed(2)}</span></div>
        ${currentPriceHTML}
        <div class="detail-item"><span class="detail-label">Total Collected</span><span class="detail-value positive">${formatMoney(totalPremium)}</span></div>
        ${plPerContractHTML}
        ${price > 0 ? `<div class="detail-item"><span class="detail-label">${pos.symbol} Price</span><span class="detail-value">$${price.toFixed(2)}</span></div>` : ''}
        ${plHTML}
        ${pos.closePrice ? `<div class="detail-item"><span class="detail-label">Close Price</span><span class="detail-value">$${pos.closePrice.toFixed(2)}</span></div>` : ''}
      </div>
      ${greeksHTML}
      <div class="action-recommendation ${action.cls}">${action.text}</div>
      ${notesHTML}
    </div>`;
}

function renderDashboard() {
  const dataEl = document.getElementById('positions-data');
  if (!dataEl) return;
  
  const data = JSON.parse(dataEl.textContent);
  const { positions, prices, optionPrices, lastUpdated } = data;
  
  // Update time
  if (lastUpdated) {
    const d = new Date(lastUpdated);
    document.getElementById('update-time').textContent = 'Last updated: ' + d.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) + ' PT';
  }
  
  // Classify positions
  const active = [];
  const expiring = [];
  const closed = [];
  
  for (const pos of positions) {
    const dte = getDTE(pos.expiration);
    if (['rolled', 'closed'].includes(pos.status)) {
      closed.push(pos);
    } else if (['expiring_worthless', 'expired'].includes(pos.status) || dte < 0) {
      expiring.push(pos);
    } else if (dte === 0) {
      expiring.push(pos);
    } else {
      active.push(pos);
    }
  }
  
  // Sort active: soonest expiry first, then by symbol
  active.sort((a, b) => {
    const dteDiff = getDTE(a.expiration) - getDTE(b.expiration);
    if (dteDiff !== 0) return dteDiff;
    return a.symbol.localeCompare(b.symbol);
  });
  
  // Summary stats
  const totalPremium = active.reduce((sum, p) => sum + (p.premiumCollected || p.entryPrice * Math.abs(p.contracts) * 100), 0);
  const expiringThisWeek = active.filter(p => getDTE(p.expiration) <= 7).length;
  const itmCount = active.filter(p => {
    const price = prices[p.symbol] || 0;
    return p.type === 'call' ? price >= p.strike : price <= p.strike;
  }).length;

  // Monthly P/L calculation
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthName = now.toLocaleString('default', { month: 'short' });

  // Closed positions this month: net profit = premiumCollected - closeCost
  const closedThisMonth = data.positions.filter(p => {
    if (!['closed', 'rolled'].includes(p.status)) return false;
    const closeDate = p.closeDate ? new Date(p.closeDate + 'T00:00:00') : null;
    return closeDate && closeDate >= monthStart;
  });
  const closedPL = closedThisMonth.reduce((sum, p) => {
    const premium = p.premiumCollected || (p.entryPrice * Math.abs(p.contracts) * 100);
    const cost = p.closeCost || 0;
    return sum + (premium - cost);
  }, 0);

  // Expired positions this month: full premium kept
  const expiredThisMonth = [...expiring, ...data.positions.filter(p => 
    ['expired', 'expiring_worthless'].includes(p.status)
  )].filter(p => {
    const exp = new Date(p.expiration + 'T00:00:00');
    return exp >= monthStart && exp <= now;
  });
  const expiredPL = expiredThisMonth.reduce((sum, p) => {
    return sum + (p.premiumCollected || (p.entryPrice * Math.abs(p.contracts) * 100));
  }, 0);

  const monthlyPL = closedPL + expiredPL;
  const plClass = monthlyPL >= 0 ? 'positive' : 'negative';
  const plSign = monthlyPL >= 0 ? '+' : '';
  
  document.getElementById('summary-bar').innerHTML = `
    <div class="summary-item"><span class="summary-icon">üìà</span><div class="summary-text"><span class="summary-label">${monthName} P/L (Realized)</span><span class="summary-value ${plClass}">${plSign}${formatMoney(monthlyPL)}</span></div></div>
    <div class="summary-item"><span class="summary-icon">üìä</span><div class="summary-text"><span class="summary-label">Active Positions</span><span class="summary-value">${active.length}</span></div></div>
    <div class="summary-item"><span class="summary-icon">üí∞</span><div class="summary-text"><span class="summary-label">Premium at Risk</span><span class="summary-value positive">${formatMoney(totalPremium)}</span></div></div>
    <div class="summary-item"><span class="summary-icon">‚è∞</span><div class="summary-text"><span class="summary-label">Expiring ‚â§7 Days</span><span class="summary-value ${expiringThisWeek > 0 ? 'warning' : ''}">${expiringThisWeek}</span></div></div>
    <div class="summary-item"><span class="summary-icon">‚ö†Ô∏è</span><div class="summary-text"><span class="summary-label">ITM Positions</span><span class="summary-value ${itmCount > 0 ? 'negative' : ''}">${itmCount}</span></div></div>
  `;
  
  // Render active
  document.getElementById('active-positions').innerHTML = active.length > 0 
    ? active.map(p => renderCard(p, prices, optionPrices)).join('')
    : '<div style="color: var(--text-muted); text-align: center; padding: 40px;">No active positions</div>';
  
  // Render expiring/expired
  if (expiring.length > 0) {
    document.getElementById('expiring-section').classList.remove('hidden');
    document.getElementById('expiring-grid').innerHTML = expiring.map(p => renderCard(p, prices, optionPrices)).join('');
  }
  
  // Render closed/rolled
  if (closed.length > 0) {
    document.getElementById('closed-section').classList.remove('hidden');
    document.getElementById('closed-grid').innerHTML = closed.map(p => renderCard(p, prices, optionPrices)).join('');
  }
}

function toggleSection(gridId) {
  const grid = document.getElementById(gridId);
  const toggle = document.getElementById(gridId + '-toggle');
  if (grid.style.display === 'none') {
    grid.style.display = 'grid';
    toggle.textContent = '‚ñº';
  } else {
    grid.style.display = 'none';
    toggle.textContent = '‚ñ∂';
  }
}

// Init ‚Äî deferred until DOMContentLoaded to ensure data block is available
document.addEventListener('DOMContentLoaded', renderDashboard);
</script>

<!-- DATA BLOCK: Updated by callworks-update-active script -->
<script id="positions-data" type="application/json">
{"prices": {"AMZN": 210.43, "ARKK": 73.1, "GOOG": 318.41, "INTC": 47.84, "LMND": 71.79, "MSFT": 420.6, "NVDA": 189.62, "PLTR": 141.22, "TSLA": 423.73}, "positions": [{"symbol": "TSLA", "type": "call", "strike": 450, "expiration": "2026-02-13", "contracts": -11, "entryPrice": 0.44, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 484.0, "otmPct": 6.1, "dte": 3, "notes": "\u2705 6.1% OTM at $424.25, 3 DTE - let expire"}, {"symbol": "TSLA", "type": "call", "strike": 457.5, "expiration": "2026-02-13", "contracts": -75, "entryPrice": 0.25, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 1875.0, "otmPct": 7.8, "dte": 3, "notes": "\u2705 7.8% OTM at $424.25, 3 DTE - let expire"}, {"symbol": "NVDA", "type": "call", "strike": 200, "expiration": "2026-02-20", "contracts": -10, "entryPrice": 2.23, "entryDate": "2026-02-09", "status": "safe", "premiumCollected": 2230.0, "otmPct": 5.2, "dte": 10, "notes": "\u2705 5.2% OTM at $190.05, 10 DTE - comfortable buffer"}, {"symbol": "GOOG", "type": "call", "strike": 335, "expiration": "2026-04-17", "contracts": -6, "entryPrice": 6.03, "status": "hold", "otmPct": 5.1, "dte": 66, "notes": "\u2705 5.1% OTM at $318.65, 66 DTE - rebounded from lows"}, {"symbol": "GOOG", "type": "call", "strike": 340, "expiration": "2026-06-18", "contracts": -5, "entryPrice": 6.23, "status": "hold", "otmPct": 6.7, "dte": 128, "notes": "\u2705 6.7% OTM at $318.65, 128 DTE - comfortable"}, {"symbol": "LMND", "type": "call", "strike": 92, "expiration": "2026-03-06", "contracts": -7, "entryPrice": 12.25, "status": "hold", "profitPct": 78.55, "otmPct": 27.4, "dte": 24, "notes": "\u2705 27.4% OTM at $72.22, 24 DTE - very safe"}, {"symbol": "LMND", "type": "call", "strike": 85, "expiration": "2026-02-13", "contracts": -2, "entryPrice": 0.45, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 90.0, "otmPct": 17.7, "dte": 3, "notes": "\u2705 17.7% OTM at $72.22, 3 DTE - let expire"}, {"symbol": "ARKK", "type": "call", "strike": 80, "expiration": "2026-02-20", "contracts": -16, "entryPrice": 0.16, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 256.0, "otmPct": 9.2, "dte": 10, "notes": "\u2705 9.2% OTM at $73.28, 10 DTE"}, {"symbol": "INTC", "type": "call", "strike": 55, "expiration": "2026-02-20", "contracts": -4, "entryPrice": 0.89, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 356.0, "otmPct": 14.2, "dte": 10, "notes": "\u2705 14.2% OTM at $48.18, 10 DTE - INTC down 4%, calls very safe"}, {"symbol": "MSFT", "type": "call", "strike": 450, "expiration": "2026-02-20", "contracts": -1, "entryPrice": 0.48, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 48.0, "otmPct": 6.5, "dte": 10, "notes": "\u2705 6.5% OTM at $422.53, 10 DTE - MSFT up 2.2% but still safe"}, {"symbol": "PLTR", "type": "call", "strike": 165, "expiration": "2026-02-13", "contracts": -2, "entryPrice": 0.08, "entryDate": "2026-02-09", "status": "hold", "premiumCollected": 16.0, "otmPct": 15.4, "dte": 3, "notes": "\u2705 15.4% OTM at $142.95, 3 DTE - let expire"}, {"symbol": "AMZN", "type": "put", "strike": 230, "expiration": "2026-03-20", "contracts": -1, "entryPrice": 21.74, "entryDate": "2026-02-09", "status": "warning", "premiumCollected": 2174.0, "otmPct": -8.2, "dte": 38, "notes": "\u26a0\ufe0f ITM by 8.2% at $211.11, 38 DTE - AMZN recovered +1.15%, improved from -10.2%"}], "optionPrices": {"TSLA_450_2026-02-13_call": {"bid": 0.46, "ask": 0.47, "last": 0.46, "iv": 4453.0, "delta": 0.0564, "gamma": 0.0058, "theta": -0.2784, "vega": 0.0496, "volume": 10084, "oi": 17825}, "TSLA_457.5_2026-02-13_call": {"bid": 0.21, "ask": 0.23, "last": 0.24, "iv": 4558.0, "delta": 0.0291, "gamma": 0.0033, "theta": -0.1664, "vega": 0.029, "volume": 3148, "oi": 478}, "NVDA_200_2026-02-20_call": {"bid": 1.78, "ask": 1.83, "last": 1.8, "iv": 3934.0, "delta": 0.2426, "gamma": 0.0241, "theta": -0.1889, "vega": 0.1032, "volume": 38491, "oi": 96934}, "GOOG_335_2026-04-17_call": {"bid": 13.35, "ask": 13.55, "last": 13.55, "iv": 3113.0, "delta": 0.4493, "gamma": 0.0091, "theta": -0.1401, "vega": 0.5497, "volume": 133, "oi": 2352}, "GOOG_340_2026-06-18_call": {"bid": 21, "ask": 21.25, "last": 20.91, "iv": 3391.0, "delta": 0.4708, "gamma": 0.0061, "theta": -0.1129, "vega": 0.7666, "volume": 135, "oi": 4411}, "LMND_92_2026-03-06_call": {"bid": 2.3, "ask": 4, "last": 3.14, "iv": 11565.0, "delta": 0.2696, "gamma": 0.015, "theta": -0.1473, "vega": 0.063, "volume": 1, "oi": 14}, "LMND_85_2026-02-13_call": {"bid": 0.1, "ask": 0.35, "last": 0.39, "iv": 9724.0, "delta": 0.0712, "gamma": 0.0183, "theta": -0.1265, "vega": 0.0104, "volume": 76, "oi": 130}, "ARKK_80_2026-02-20_call": {"bid": 0.1, "ask": 0.26, "last": 0.22, "iv": 4159.0, "delta": 0.0928, "gamma": 0.0318, "theta": -0.0402, "vega": 0.0209, "volume": 516, "oi": 10614}, "INTC_55_2026-02-20_call": {"bid": 0.72, "ask": 0.77, "last": 0.75, "iv": 6620.0, "delta": 0.2347, "gamma": 0.0532, "theta": -0.0814, "vega": 0.0268, "volume": 13617, "oi": 32172}, "MSFT_450_2026-02-20_call": {"bid": 0.44, "ask": 0.46, "last": 0.47, "iv": 2915.0, "delta": 0.0521, "gamma": 0.0051, "theta": -0.1029, "vega": 0.0765, "volume": 2828, "oi": 16105}, "PLTR_165_2026-02-13_call": {"bid": 0.05, "ask": 0.06, "last": 0.05, "iv": 6242.0, "delta": 0.0154, "gamma": 0.0041, "theta": -0.0453, "vega": 0.0058, "volume": 11047, "oi": 5244}, "AMZN_230_2026-03-20_put": {"bid": 22.25, "ask": 22.9, "last": 22.27, "iv": 2812.0, "delta": -0.8504, "gamma": 0.0126, "theta": -0.0451, "vega": 0.1558, "volume": 454, "oi": 7413}}, "lastUpdated": "2026-02-10T08:47:00.014605"}
</script>

</body>
</html>